{% extends "base.html" %}
{% block title %}Company Info - StockSense{% endblock %}
{% block content %}
<div class="min-h-screen bg-black py-8 px-2">
    <h1 class="text-4xl font-extrabold text-green-400 mb-8 text-center tracking-wide drop-shadow-lg">{{ company_name }}</h1>
    <div class="flex flex-col md:flex-row gap-8 w-full max-w-[1600px] mx-auto" x-data="{ tab: '' }">
        <!-- Chart Section -->
        <div :class="tab ? 'flex-1' : 'w-full'" class="transition-all duration-500 flex flex-col items-center">
            <div :class="tab ? 'max-w-2xl' : 'max-w-5xl'" class="bg-black/70 backdrop-blur-md rounded-2xl p-8 w-full h-96 flex flex-col items-center justify-center shadow-2xl border-2 border-green-700/40 transition-all duration-500 relative">
                <div class="w-full flex justify-center mb-2">
                    <div id="periodButtons" class="flex gap-2">
                        <button class="period-btn px-3 py-1 rounded text-green-200 border border-green-700 bg-black hover:bg-green-900 transition text-sm font-semibold" data-period="5d">5D</button>
                        <button class="period-btn px-3 py-1 rounded text-green-200 border border-green-700 bg-black hover:bg-green-900 transition text-sm font-semibold" data-period="1mo">1M</button>
                        <button class="period-btn px-3 py-1 rounded text-green-200 border border-green-700 bg-black hover:bg-green-900 transition text-sm font-semibold" data-period="6mo">6M</button>
                        <button class="period-btn px-3 py-1 rounded text-green-200 border border-green-700 bg-black hover:bg-green-900 transition text-sm font-semibold" data-period="ytd">YTD</button>
                        <button class="period-btn px-3 py-1 rounded text-green-200 border border-green-700 bg-black hover:bg-green-900 transition text-sm font-semibold" data-period="1y">1Y</button>
                        <button class="period-btn px-3 py-1 rounded text-green-200 border border-green-700 bg-black hover:bg-green-900 transition text-sm font-semibold" data-period="5y">5Y</button>
                        <button class="period-btn px-3 py-1 rounded text-green-200 border border-green-700 bg-black hover:bg-green-900 transition text-sm font-semibold" data-period="max">Max</button>
                    </div>
                </div>
                <div id="chartLoading" class="absolute inset-0 flex items-center justify-center z-10">
                    <svg class="animate-spin h-12 w-12 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                    </svg>
                </div>
                <canvas id="stockChart" class="w-full h-full"></canvas>
                <div id="chartError" class="hidden absolute inset-0 flex items-center justify-center z-20">
                    <span class="text-red-400 text-xl font-semibold">No data available for this stock.</span>
                </div>
            </div>
                <div class="flex flex-row gap-8 mt-8 w-full justify-center">
                <button id="predictBtn" @click="tab = 'predict'" class="w-56 px-6 py-3 border-2 border-green-500 bg-black italic font-semibold text-lg rounded-lg text-green-400 hover:bg-green-900 hover:text-green-200 transition focus:outline-none shadow">predict</button>
                <button @click="tab = 'news'" class="w-56 px-6 py-3 border-2 border-green-500 bg-black italic font-semibold text-lg rounded-lg text-green-400 hover:bg-green-900 hover:text-green-200 transition focus:outline-none shadow">news</button>
                <button @click="tab = 'chatbot'" class="w-56 px-6 py-3 border-2 border-green-500 bg-black italic font-semibold text-lg rounded-lg text-green-400 hover:bg-green-900 hover:text-green-200 transition focus:outline-none shadow">chatbot</button>
            </div>
        </div>
        <!-- Dynamic Section -->
        <template x-if="tab">
            <div class="flex-1 min-w-[320px] max-w-lg transition-all duration-500 flex items-center">
                <div class="w-full relative">
                    <button @click="tab = ''" class="absolute top-4 right-4 px-3 py-1 bg-green-900 text-green-200 border border-green-600 rounded hover:bg-green-700 transition text-sm font-semibold">Hide âœ•</button>
                    <template x-if="tab === 'predict'">
                        <div class="bg-black rounded-2xl p-8 shadow-2xl border border-green-700 w-full">
                            <h2 class="text-2xl font-bold mb-2 text-green-400">Predict Price</h2>
                            <p class="text-green-200 mb-4">Prediction results for <strong>{{ company_name }}</strong></p>
                            <div id="predictPanel">
                                <div id="predictLoading" class="hidden w-full flex items-center justify-center mb-4">
                                    <svg class="animate-spin h-10 w-10 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                                    </svg>
                                </div>
                                <div id="predictResults" class="hidden">
                                    <div class="text-green-200 mb-2">Last close: <span id="lastClose" class="font-semibold"></span> (as of <span id="lastDate"></span>)</div>
                                    <div class="text-green-200 mb-2">Predicted:</div>
                                    <ul id="predList" class="list-disc list-inside text-green-200"></ul>
                                </div>
                                <div id="predictError" class="hidden text-red-400 font-semibold">Prediction failed. Try again later.</div>
                            </div>
                        </div>
                    </template>
                    <template x-if="tab === 'news'">
                        <div class="bg-black rounded-2xl p-8 shadow-2xl border border-green-700 w-full">
                            <h2 class="text-2xl font-bold mb-2 text-green-400">Market News</h2>
                            <p class="text-green-200">Latest news for <strong>{{ company_name }}</strong> will appear here.</p>
                        </div>
                    </template>
                    <template x-if="tab === 'chatbot'">
                        <div class="bg-black rounded-2xl p-8 shadow-2xl border border-green-700 w-full">
                            <h2 class="text-2xl font-bold mb-2 text-green-400">AI Chatbot</h2>
                            <p class="text-green-200">Chatbot for <strong>{{ company_name }}</strong> will appear here.</p>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </div>
</div>
{% endblock %}
{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('stockChart').getContext('2d');
        const loading = document.getElementById('chartLoading');
        const errorDiv = document.getElementById('chartError');
        const symbol = {{ company_name|tojson }};
        const periodButtons = document.querySelectorAll('.period-btn');
        let chart;
        let currentPeriod = 'max';
        let lastPrediction = null; // Variable to store the last prediction

        // Watch for the prediction panel being hidden and clear predictions
        document.addEventListener('alpine:init', () => {
            Alpine.data('stockApp', () => ({
                tab: '',
                init() {
                    this.$watch('tab', value => {
                        if (value !== 'predict') {
                            lastPrediction = null;
                            removeExistingPredictionDataset();
                            if (chart) chart.update();
                        }
                    });
                }
            }));
        });

        async function fetchAndRender(period) {
            try {
                loading.style.display = 'flex';
                errorDiv.classList.add('hidden');
                if (chart) { chart.destroy(); }
                // Fetch historical data for selected period
                const resp = await fetch(`/api/stock-history?symbol=${encodeURIComponent(symbol)}&period=${encodeURIComponent(period)}`);
                const data = await resp.json();
                // If API returned an error, show it in the chart error area for easier debugging
                if (!resp.ok || (data && data.error)) {
                    loading.style.display = 'none';
                    const msg = (data && data.error) ? data.error : `Failed to fetch history (status ${resp.status})`;
                    errorDiv.classList.remove('hidden');
                    errorDiv.innerHTML = `<span class="text-red-400 text-xl font-semibold">${msg}</span>`;
                    console.error('Stock history API error:', msg, data);
                    return;
                }
                let chartData = {
                    labels: [],
                    datasets: [{
                        label: symbol + ' Close Price',
                        data: [],
                        borderColor: '#22d3a3',
                        backgroundColor: 'rgba(34,211,163,0.1)',
                        pointRadius: 0,
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                    }]
                };
                if (data.history && data.history.length > 0) {
                    chartData.labels = data.history.map(d => d.x);
                    chartData.datasets[0].data = data.history.map(d => d.y);
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: { unit: period === '1d' || period === '5d' ? 'day' : (period === '1mo' || period === '6mo' ? 'month' : 'year') },
                                    ticks: { color: '#a7f3d0' },
                                    grid: { color: 'rgba(34,211,163,0.1)' }
                                },
                                y: {
                                    ticks: { color: '#a7f3d0' },
                                    grid: { color: 'rgba(34,211,163,0.1)' }
                                }
                            }
                        }
                    });
                    loading.style.display = 'none';

                    // --- FIX: Re-apply predictions if panel is open ---
                    if (lastPrediction) {
                        addPredictionsToChart(lastPrediction);
                    }
                    // --- End Fix ---

                } else {
                    loading.style.display = 'none';
                    errorDiv.classList.remove('hidden');
                }
            } catch (e) {
                loading.style.display = 'none';
                errorDiv.classList.remove('hidden');
                const msg = (e && e.message) ? e.message : String(e);
                errorDiv.innerHTML = `<span class="text-red-400 text-xl font-semibold">Fetch error: ${msg}</span>`;
                console.error('Fetch exception while getting stock history:', e);
            }
        }

        // Button click handler
        periodButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                periodButtons.forEach(b => b.classList.remove('border-green-400', 'bg-green-900', 'text-green-100'));
                this.classList.add('border-green-400', 'bg-green-900', 'text-green-100');
                currentPeriod = this.getAttribute('data-period');
                fetchAndRender(currentPeriod);
            });
        });
        // Set default (Max) active
        periodButtons[periodButtons.length - 1].classList.add('border-green-400', 'bg-green-900', 'text-green-100');
        fetchAndRender(currentPeriod);

        // Prediction: hook up predict button and panel
        const predictBtn = document.getElementById('predictBtn');

        // helper to wait for elements rendered by Alpine's x-if
        async function waitForElements(ids, timeout = 1500) {
            const start = Date.now();
            while (Date.now() - start < timeout) {
                const found = ids.map(id => document.getElementById(id));
                if (found.every(el => el !== null)) return found;
                await new Promise(r => setTimeout(r, 100));
            }
            return ids.map(id => document.getElementById(id));
        }

        function removeExistingPredictionDataset() {
            if (!chart || !chart.data || !chart.data.datasets) return;
            const idx = chart.data.datasets.findIndex(d => d && d.label && d.label.toLowerCase().includes('predicted'));
            if (idx !== -1) {
                chart.data.datasets.splice(idx, 1);
            }
        }

        function addPredictionsToChart(predictions) {
            if (!chart || !predictions || predictions.length === 0) return;
            removeExistingPredictionDataset();

            const dataset = {
                label: 'Predicted',
                data: predictions, // Use predictions directly
                borderColor: '#f97316',
                backgroundColor: 'rgba(249,115,22,0.06)',
                pointRadius: 3,
                borderWidth: 2,
                borderDash: [6, 4],
                tension: 0.2,
                fill: false
            };
            chart.data.datasets.push(dataset);

            // Adjust chart axis to show predictions
            const lastPredictionDate = new Date(predictions[predictions.length - 1].x);
            const lastHistoryDate = new Date(chart.data.labels[chart.data.labels.length - 1]);
            
            if (lastPredictionDate > lastHistoryDate) {
                 chart.options.scales.x.max = lastPredictionDate.valueOf();
            }

            chart.update();
        }

        async function runPrediction(days = 7) {
            // ensure panel elements are present (Alpine x-if renders them after tab change)
            const [predictLoading, predictResults, predictError, predList, lastCloseEl, lastDateEl] = await waitForElements([
                'predictLoading', 'predictResults', 'predictError', 'predList', 'lastClose', 'lastDate'
            ], 2000);
            if (!predictLoading || !predictResults || !predList) {
                console.warn('Prediction UI elements not found; aborting prediction');
                return;
            }
            predictError.classList.add('hidden');
            predictResults.classList.add('hidden');
            predList.innerHTML = '';
            predictLoading.classList.remove('hidden');

            try {
                // include the currently selected period so backend uses the same history as the chart
                const resp = await fetch(`/api/predict?symbol=${encodeURIComponent(symbol)}&days=${encodeURIComponent(days)}&period=${encodeURIComponent(currentPeriod)}`);
                const json = await resp.json();
                predictLoading.classList.add('hidden');
                if (json.error) {
                    predictError.textContent = json.error || 'Prediction failed';
                    predictError.classList.remove('hidden');
                    lastPrediction = null; // Clear stored prediction on error
                    return;
                }

                // Show results
                lastCloseEl.textContent = json.last_close ? json.last_close.toFixed(2) : 'N/A';
                lastDateEl.textContent = json.last_date || '';
                json.predictions.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.x}: ${Number(p.y).toFixed(2)}`;
                    predList.appendChild(li);
                });
                predictResults.classList.remove('hidden');

                // --- FIX: Store prediction and overlay on chart ---
                lastPrediction = json.predictions;
                addPredictionsToChart(lastPrediction);
                // --- End Fix ---
            } catch (e) {
                predictLoading.classList.add('hidden');
                predictError.textContent = 'Prediction failed. ' + (e && e.message ? e.message : '');
                predictError.classList.remove('hidden');
                lastPrediction = null; // Clear stored prediction on error
            }
        }

        // Run prediction when the predict button is clicked (opens panel via Alpine and triggers prediction)
        if (predictBtn) {
            predictBtn.addEventListener('click', function() {
                // small delay to let Alpine open the panel
                setTimeout(() => runPrediction(7), 220);
            });
        }
    });
    </script>
{% endblock %}
